<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - IRS Issue Reporting System</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <h2>IRS</h2>
                    <span>Issue Reporting System - Admin</span>
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
                    ‚ò∞
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" data-tooltip="Dashboard" data-section="dashboard-section">
                    <i>üè†</i> <span>Dashboard</span>
                </a>
                <a href="#reports" class="nav-item" data-tooltip="All Reports" data-section="reports-section">
                    <i>üìã</i> <span>All Reports</span>
                </a>
                <a href="#users" class="nav-item" data-tooltip="Users" data-section="users-section">
                    <i>üë•</i> <span>Users</span>
                </a>
                <a href="#analytics" class="nav-item" data-tooltip="Analytics" data-section="analytics-section">
                    <i>üìä</i> <span>Analytics</span>
                </a>
                <a href="#settings" class="nav-item" data-tooltip="Settings" data-section="settings-section">
                    <i>‚öôÔ∏è</i> <span>Settings</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
            <div class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <p>Manage and oversee all issue reports in the system</p>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Total Reports</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Resolved Issues</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Pending Review</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Active Users</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-actions">
                <button class="btn-primary" onclick="viewAllReports()">View All Reports</button>
                <button class="btn-secondary" onclick="manageUsers()">Manage Users</button>
                <button class="btn-secondary" onclick="viewAnalytics()">View Analytics</button>
            </div>

            <div class="recent-reports">
                <h2>Recent Reports</h2>
                <div class="reports-list">
                    <div class="no-reports">
                        <p>No reports to review yet.</p>
                    </div>
                </div>
            </div>

            <div class="admin-panel">
                <h2>Admin Actions</h2>
                <div class="admin-actions">
                    <button class="btn-primary" onclick="assignReports()">Assign Reports</button>
                    <button class="btn-secondary" onclick="updateStatus()">Update Status</button>
                    <button class="btn-secondary" onclick="exportData()">Export Data</button>
                </div>
            </div>
            </div>

            <!-- All Reports Section -->
            <div id="reports-section" class="reports-section">
                <div class="section-header">
                    <h1>All Reports</h1>
                    <p>Manage all reports in the system</p>
                </div>
                <div class="dashboard-actions">
                    <button class="btn-primary" onclick="loadAllReports()">Refresh Reports</button>
                    <button class="btn-secondary" onclick="exportData()">Export Data</button>
                </div>
                <div class="all-reports-list">
                    <div class="no-reports">
                        <p>Loading reports...</p>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="users-section">
                <div class="section-header">
                    <h1>User Management</h1>
                    <p>Manage system users and their permissions</p>
                </div>
                <div class="dashboard-actions">
                    <button class="btn-primary" onclick="loadUsers()">Refresh Users</button>
                    <button class="btn-secondary" onclick="createUser()">Create User</button>
                </div>
                <div class="users-list">
                    <div class="no-reports">
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" class="analytics-section">
                <div class="section-header">
                    <h1>Analytics</h1>
                    <p>System performance and usage statistics</p>
                </div>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3 id="totalReports">0</h3>
                        <p>Total Reports</p>
                    </div>
                    <div class="analytics-card">
                        <h3 id="resolvedReports">0</h3>
                        <p>Resolved Reports</p>
                    </div>
                    <div class="analytics-card">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="analytics-card">
                        <h3 id="avgResolutionTime">0</h3>
                        <p>Avg Resolution Time (days)</p>
                    </div>
                </div>
                <div class="dashboard-actions">
                    <button class="btn-primary" onclick="loadAnalytics()">Refresh Analytics</button>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="settings-section">
                <div class="section-header">
                    <h1>Admin Settings</h1>
                    <p>Configure system settings and preferences</p>
                </div>
                <div class="settings-grid">
                    <div class="setting-card">
                        <h3>System Configuration</h3>
                        <p>Configure system-wide settings</p>
                        <button class="btn-secondary" onclick="configureSystem()">Configure</button>
                    </div>
                    <div class="setting-card">
                        <h3>Email Settings</h3>
                        <p>Manage email notifications and templates</p>
                        <button class="btn-secondary" onclick="configureEmail()">Configure</button>
                    </div>
                    <div class="setting-card">
                        <h3>Backup & Restore</h3>
                        <p>Manage system backups and data restoration</p>
                        <button class="btn-secondary" onclick="backupSystem()">Backup Now</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="script.js"></script>
    <script>
        // Admin dashboard specific functions
        function viewAllReports() {
            alert('View all reports feature coming soon!');
        }

        function manageUsers() {
            alert('User management feature coming soon!');
        }

        function viewAnalytics() {
            alert('Analytics feature coming soon!');
        }

        function assignReports() {
            alert('Report assignment feature coming soon!');
        }

        function updateStatus() {
            alert('Status update feature coming soon!');
        }

        function exportData() {
            alert('Data export feature coming soon!');
        }

        // Load user data on dashboard load
        document.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userRole = localStorage.getItem('userRole');
            
            if (user.email) {
                document.querySelector('.dashboard-header h1').textContent = `Admin Dashboard - Welcome, ${user.user_metadata?.full_name || user.email}!`;
            }
            
            // Verify admin access
            if (userRole !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'login.html';
            }
            
            // Load admin data
            loadAllReports();
            loadAnalytics();
        });

        async function loadUsers() {
            try {
                const { data, error } = await supabase.auth.admin.listUsers();
                if (error) throw error;
                
                displayUsers(data.users || []);
            } catch (error) {
                console.error('Error loading users:', error);
                document.querySelector('.users-list').innerHTML = '<div class="no-reports"><p>Error loading users.</p></div>';
            }
        }

        function displayUsers(users) {
            const usersList = document.querySelector('.users-list');
            if (!usersList) return;
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="no-reports"><p>No users found.</p></div>';
                return;
            }
            
            usersList.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-info">
                        <h4>${user.user_metadata?.full_name || user.email}</h4>
                        <p>${user.email} ‚Ä¢ ${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown'}</p>
                    </div>
                    <div class="user-actions">
                        <button class="btn-secondary" onclick="viewUser('${user.id}')">View</button>
                        <button class="btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadAnalytics() {
            try {
                const { data: reports, error: reportsError } = await supabase
                    .from('reports')
                    .select('*');
                
                if (reportsError) throw reportsError;
                
                const { data: users, error: usersError } = await supabase.auth.admin.listUsers();
                if (usersError) throw usersError;
                
                const totalReports = reports.length;
                const resolvedReports = reports.filter(r => r.status === 'Resolved').length;
                const activeUsers = users.users.length;
                const avgResolutionTime = calculateAvgResolutionTime(reports);
                
                document.getElementById('totalReports').textContent = totalReports;
                document.getElementById('resolvedReports').textContent = resolvedReports;
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('avgResolutionTime').textContent = avgResolutionTime;
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function calculateAvgResolutionTime(reports) {
            const resolvedReports = reports.filter(r => r.status === 'Resolved' && r.updated_at);
            if (resolvedReports.length === 0) return 0;
            
            const totalDays = resolvedReports.reduce((sum, report) => {
                const created = new Date(report.created_at);
                const resolved = new Date(report.updated_at);
                const days = (resolved - created) / (1000 * 60 * 60 * 24);
                return sum + days;
            }, 0);
            
            return Math.round(totalDays / resolvedReports.length);
        }

        function createUser() {
            alert('Create user feature coming soon!');
        }

        function viewUser(userId) {
            alert(`View user ${userId} feature coming soon!`);
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                alert(`Delete user ${userId} feature coming soon!`);
            }
        }

        function configureSystem() {
            alert('System configuration feature coming soon!');
        }

        function configureEmail() {
            alert('Email configuration feature coming soon!');
        }

        function backupSystem() {
            alert('System backup feature coming soon!');
        }
    </script>
</body>
</html>
